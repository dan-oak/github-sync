#!/usr/bin/env zsh

set -e

pushd $(dirname $(greadlink -f $0))

fpath=(.)
autoload env assert-env github-list-repos extract instruct execute log

source `which env_parallel.zsh`

env
assert-env

mkdir -p $GITHUB_SYNC_DIR

data_d=../data
github_repos_response_d=$data_d/github-repos-response
github_repos_name_f=$data_d/github-repos-name.txt
local_repos_name_f=$data_d/local-repos-name.txt
comm_f=$data_d/comm.txt
instructions_f=$data_d/instructions.txt

# --------------------------------------------------------------------------- #

# List GitHub repos
github-list-repos $github_repos_response_d

# Extract names of active repos
extract $github_repos_response_d/* >$github_repos_name_f

# List local repos
ls $GITHUB_SYNC_DIR >$local_repos_name_f

# Compare GitHub and local repos
gcomm $github_repos_name_f $local_repos_name_f >$comm_f

# Prepare fetch/clone/remove instructions
instruct <$comm_f >$instructions_f

if ((GITHUB_SYNC_DEBUG)) {
  while read instruction; do execute ${=instruction}; done < $instructions_f
} else {
  # Execute instructions in parallel
  env_parallel -a $instructions_f --colsep ' ' execute
}

popd